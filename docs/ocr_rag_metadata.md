### תיעוד OCR → RAG: מבנה, CLI, ותוצאות השוואת מודלים (Qwen מול Mistral)

מסמך זה מרכז את כל המידע העדכני על צינור ה־OCR→RAG, פורמטי הפלט והמטא־דאטה, ממשקי ה־CLI החדשים (כולל מענה רב־שאלתי עם ציטוטים וסיכום כרונולוגי), ותוצאות הרצה אמיתיות עם Qwen לעומת Mistral. על בסיס ההרצות שבוצעו, Qwen ניצח.

### ארטיפקטים הנוצרים בצינור
- `ocr_out/results.json`: תוצר ה־OCR לכל העמודים (כולל קואורדינטות טקסט).
- `ocr_out/structured_documents.jsonl`: שורה אחת לכל מסמך לוגי שמורכב מרצף עמודים.
- `ocr_out/documents_index.json`: אינדקס מהיר ממזהה מסמך לשדות עיקריים.
- `ocr_out/ocr_embeddings/index.faiss`: אינדקס FAISS על צ'אנקים של המסמכים.
- `ocr_out/ocr_embeddings/meta.jsonl`: מטא־דאטה על כל צ'אנק (לציטוטים וסינון).
- `ocr_out/ocr_embeddings/model.json`: פרטי מודל ההטמעה ששימש (שם, ממד, מכשיר).

### מבנה structured_documents.jsonl (לפני צ'אנקינג)
כל שורה היא JSON עם השדות העיקריים הבאים:
- `document_id` (string): מזהה מסמך יציב (EM/ME/ביקור/או AUTO-… אם לא נמצא).
- `original_id` (string): מזהה מקורי, אם זוהה.
- `document_type` (string): טיפוס מסמך בזיהוי הֵאוּרִיסְטִי, למשל: "דוח שחרור מחדר מיון", "דוח ביקור מרפאה", "סיכום טיפול פיזיותרפיה", "טופס סיכום בדיקה רפואית (רפואה תעסוקתית)", "תעודה רפואית לנפגע בעבודה", "ועדה רפואית", "בל/250", "תעודת זהות", "UNKNOWN".
- `document_date` (YYYY-MM-DD | null): תאריך מסמך שנבחר לפי עדיפויות חכמות (לייבלים כמו ביקור/שחרור/תוקף, אזור עליון בדף, ועוד).
- `issuer` (string | null): הגוף/רופא מנפיק.
- `pages` (int[]): רשימת מספרי עמודים מקוריים ב־PDF.
- `text` (string): טקסט מלא מאוחד של המסמך.
- `source` (string): נתיב ה־PDF המקורי.
- `patient_name` (string | null): שם המטופל אם זוהה.
- `found_dates` (string[]): כל התאריכים שנמצאו (ISO), לשקיפות.
- `detected_keywords` (string[]): רמזים תמאטיים לשאלות ("מצב תפקודי", "רפואה תעסוקתית", "אישור/חופש מחלה").
- `category` (string): סיווג נורמליזציה: "ביקור רופא כללי" | "ביקור רופא תעסוקתי" | "ביקור במיון" | "טופס ביטוח" | "אחר".
- `chron_id` (int): מזהה כרונולוגי גלובלי (מוקצה לפי סדר עולה בזמן; הפלט נשמר יורד בזמן עבור נוחות).

דוגמה קצרה:
```json
{
  "document_id": "45062778",
  "document_type": "דוח ביקור מרפאה",
  "document_date": "2025-04-11",
  "issuer": "HOLY FAMILY HOSPITAL",
  "pages": [5],
  "text": "... מנוחה מעבודה עוד חודש מהיום ...",
  "source": "/home/chezy/rag_medical/med_patient#1.pdf",
  "patient_name": "חביבאללה סאמי",
  "found_dates": ["2025-04-11"],
  "detected_keywords": ["מצב תפקודי", "אישור/חופש מחלה"],
  "category": "ביקור רופא כללי",
  "chron_id": 34
}
```

### מבנה ocr_embeddings/meta.jsonl (אחרי צ'אנקינג)
כל שורה היא צ'אנק בודד:
- `row_id` (int): מזהה תואם לאינדקס FAISS.
- שדות ירושה מהמסמך האב: `document_id`, `document_type`, `document_date`, `issuer`, `pages`, `source`, `patient_name`, `found_dates`, `category`, `chron_id`.
- `chunk_index` (int): אינדקס הצ'אנק בתוך המסמך.
- `text` (string): הטקסט של הצ'אנק (~900 תווים, חפיפה ~120).

דוגמה קצרה:
```json
{
  "row_id": 52,
  "document_id": "AUTO-טופס סיכום בדיקה רפואית (רפואה תעסוקתית)",
  "document_type": "טופס סיכום בדיקה רפואית (רפואה תעסוקתית)",
  "document_date": "2025-06-23",
  "pages": [12],
  "chunk_index": 0,
  "text": "אינו יכול לחזור עדיין לעבודתו ... המשך חופש מחלה ... עד תאריך 20/09/2025 ..."
}
```

### מידע על מודל ההטמעה
```json
{
  "model": "intfloat/multilingual-e5-large",
  "dim": 1024,
  "device": "cuda|cpu"
}
```

### ממשקי CLI רלוונטיים
- `python -m src.cli ocr_index --ocr-dir <DIR>`: בניית מסמכים, צ'אנקים ואינדקסים.
- `python -m src.cli ocr_search --ocr-dir <DIR> "שאילתה" [--type ... --category ...]`: חיפוש רלוונטי עם מטא־דאטה וציטוט קצר.
- `python -m src.cli ocr_answer --ocr-dir <DIR> "שאילתה" [--model ... --top-k ... --type ... --category ...]`: תשובה תמציתית בעברית + ציטוטים (עד 2), בפורמט JSON.
- `python -m src.cli ocr-case-report --ocr-dir <DIR> [--model ... --top-k ...]`: דוח רב־שאלתי + סיכום כרונולוגי של מסמכים רלוונטיים.

### פורמט תשובה לשאלה (Q/A)
המערכת מחזירה JSON עם:
- `question`: נוסח השאלה בעברית.
- `answer`: תשובה תמציתית בעברית (משפט–שניים), בהטיית עדכניות.
- `sources`: עד 2 מקורות ודאיים מן הרטריבר, עם `document_id`, `document_type`, `document_date`, `pages`, `quote` (קטע קצר מהמסמך המקורי).

טיפול מיוחד: לשאלה על תוקף "אישור מחלה" קיימת לוגיקה דטרמיניסטית שמחלצת טווחי תאריכים אופייניים ("מיום ... עד ...", "תוקף עד ...") וקובעת אם יש אישור בתוקף נכון להיום; במקרה זה המערכת עשויה להחזיר "כן"/"לא" עם ציטוטים דטרמיניסטיים.

### פורמט סיכום כרונולוגי
רשימת פריטים בסדר כרונולוגי עולה של מסמכים רלוונטיים, עם השדות:
- `document_name` (=`document_type`), `document_date`, `summary` (תקציר קצר), `quote` (ציטוט), `analysis` (בניתוח הרלוונטיות לתביעה), `document_id`, `pages`.

### הרצות אמיתיות: Qwen לעומת Mistral
- סביבת הרצה: Ollama מקומי, GPU אם זמין; אינפרנס דרך `/api/generate`.
- נתוני קלט: `ocr_out` הקיים במאגר זה.

- הרצה עם Qwen 2.5 7B Instruct:
  - פקודה:
    ```bash
    python -m src.cli ocr-case-report --ocr-dir /home/chezy/rag_medical/ocr_out --model qwen2.5:7b-instruct --top-k 8
    ```
  - זמן ריצה (wall clock): `elapsed=2:07.11` (נמדד עם `/usr/bin/time`).
  - פלט נשמר: `docs/outputs/case_report_qwen.json`.
  - תמצית תשובות שהתקבלו בפועל:
    - **מצב תפקודי עדכני**: המבוטח עדיין מוגבל, לא כשיר לחזרה מלאה; מצוין טיפול פיזיותרפיה והגבלות.
      - מקורות לדוגמה: `45042138` ("סיכום טיפול פיזיותרפיה", 2025-03-07, עמ' 4), ו־"טופס סיכום בדיקה רפואית (רפואה תעסוקתית)" 2025-06-23, עמ' 12.
    - **המלצת רופא תעסוקתי על חזרה לעבודה**: טרם כשיר לחזור; המשך חופשת מחלה עד 20/09/2025.
      - מקור לדוגמה: "טופס סיכום בדיקה רפואית (רפואה תעסוקתית)" 2025-06-23, עמ' 12.
    - **האם קיים אישור מחלה בתוקף?**: לא. מאותר טווח "עד 21/04/2025" ולכן אינו בתוקף כיום.
      - מקור לדוגמה: "תעודה רפואית לנפגע בעבודה" 2025-03-18, עמ' 41–42.
  - הסיכום הכרונולוגי כלל ביקור מיון/שחרור/פיזיותרפיה/טפסים תעסוקתיים/ועדה רפואית עם ציטוטים קצרים וניתוח רלוונטיות.

- הרצה עם Mistral 7B Instruct:
  - ניסיון הרצה:
    ```bash
    python -m src.cli ocr-case-report --ocr-dir /home/chezy/rag_medical/ocr_out --model mistral:7b-instruct --top-k 8
    ```
  - מצב בפועל במכונה: דגם Mistral לא מותקן ב־Ollama (`/api/tags` לא מציג אותו). ניסיון `ollama pull mistral:7b-instruct` נכשל (`Error: EOF`). לכן לא נאסף פלט.
  - הוראות לשחזור כשיהיה זמין: להריץ `ollama pull mistral:7b-instruct`, ואז אותה פקודת `ocr-case-report` ולמדוד זמן כמו ב־Qwen. ניתן לשמור בפורמט: `docs/outputs/case_report_mistral.json` ו־`docs/outputs/mistral.time`.

#### ממצאי השוואה (בשלב זה)
- **דיוק ורלוונטיות**: Qwen החזיר תשובות תמציתיות בעברית בהתאם להנחיות, בשילוב ציטוטים נכונים לפי `document_id`/`pages`, ובפרט הכריע דטרמיניסטית לגבי תוקף אישור מחלה. Mistral לא הוערך בפועל עקב חוסר דגם זמין.
- **ביצועים**: Qwen 7B לקח כ־2:07 דקות לקייס־רפורט מלא (3 שאלות + כרונולוגיה) על `ocr_out` הנוכחי במכונה הספציפית.
- **פסק דין ביניים**: Qwen מנצח במצב הקיים (גם כי הוא זמין ומספק תוצאות איכותיות). נעדכן את ההשוואה ברגע שמודל Mistral יימשך ויורץ בפועל.

### שכפול ותפעול
1) אינדוקס OCR (אם עדיין לא בוצע):
```bash
python -m src.cli ocr_index --ocr-dir /home/chezy/rag_medical/ocr_out
```
2) תשובה לשאלה בודדת עם ציטוטים:
```bash
python -m src.cli ocr_answer --ocr-dir /home/chezy/rag_medical/ocr_out "מהו מצבו התפקודי העדכני של המבוטח?" --model qwen2.5:7b-instruct
```
3) דו"ח רב־שאלתי + סיכום כרונולוגי:
```bash
python -m src.cli ocr-case-report --ocr-dir /home/chezy/rag_medical/ocr_out --model qwen2.5:7b-instruct --top-k 8
```

### הערות יישום חשובות
- החזרת ציטוטים אינה נלקחת מן המודל אלא נבנית דטרמיניסטית מרשימת התוצאות של הרטריבר (`search_ocr_index`) כדי למנוע "הזיות ציטוט".
- לוגיקת תוקף אישור מחלה סורקת מחרוזות תאריכים בעברית/מספרית ומחלצת טווחים או "תוקף עד"; אם היום בטווח, מוחזר "כן", אחרת "לא".
- תאריכים בפורמט ישראלי (`DD/MM/YYYY`) מוצגים במפורש בפרומפט למודל, כדי לעודד בחירת מסמכים עדכניים.

### מבנה פלט ומטא־דאטה ל־RAG (OCR)

מסמך זה מתעד את הפלט שנוצר לפני ואחרי הצ'אנקינג, כדי שאפשר יהיה להטמיע רטריבר בעברית בצורה עקבית ואמינה.

### קבצים נוצרים
- `ocr_out/structured_documents.jsonl`: שורה לכל מסמך לוגי (צירוף עמודים שזוהו כשייכים לאותו מסמך).
- `ocr_out/documents_index.json`: אינדקס מהיר ממזהה מסמך לשדות עיקריים.
- `ocr_out/ocr_embeddings/index.faiss`: אינדקס FAISS של הצ'אנקים המוטמעים.
- `ocr_out/ocr_embeddings/meta.jsonl`: מטא־דאטה לכל צ'אנק (לצורך סינון/ציטוטים).
- `ocr_out/ocr_embeddings/model.json`: פרטי מודל ההטמעה ששימש לאינדוקס.

### structured_documents.jsonl (לפני צ'אנקינג)
כל שורה היא אובייקט JSON עם השדות:
- `document_id` (string): מזהה מסמך יציב (נלקח מקוד דוח/EM/ME אם קיים, אחרת AUTO-…).
- `document_type` (string): טיפוס מסמך בזיהוי הֵאוּרִיסְטִי. ערכים נפוצים:
  - "דוח שחרור מחדר מיון", "דוח שחרור", "דוח ביקור מרפאה",
  - "סיכום טיפול פיזיותרפיה",
  - "טופס סיכום בדיקה רפואית (רפואה תעסוקתית)",
  - "תעודה רפואית לנפגע בעבודה",
  - "ועדה רפואית", "בל/250", "הזמנת בדיקה רפואית", "תעודת זהות", "UNKNOWN".
- `document_date` (string | null): תאריך מסמך בפורמט ISO ‏YYYY-MM-DD (נבחר המאוחר מזוהה בעמודים).
- `issuer` (string | null): הגוף/מוסד/רופא מנפיק (למשל "HOLY FAMILY HOSPITAL", "כללית", "המוסד לביטוח לאומי").
- `pages` (int[]): רשימת מספרי העמודים המקוריים ב־PDF הכלולים במסמך זה.
- `text` (string): טקסט המסמך המאוחד (צירוף עמודים בסדר עולה, עם רווחי שורה).
- `source` (string): נתיב ה־PDF המקורי.
- `patient_name` (string | null): שם המטופל/המבוטח אם זוהה.
- `found_dates` (string[]): כל התאריכים שנמצאו בעמודים (ב־ISO), לשקיפות.
- `detected_keywords` (string[]): רמזי שאלה שסווגו לצורך סינון ("מצב תפקודי", "רפואה תעסוקתית", "אישור/חופש מחלה").

דוגמה קצרה:
```json
{
  "document_id": "EM45013286",
  "document_type": "דוח שחרור מחדר מיון",
  "document_date": "2025-01-21",
  "issuer": "HOLY FAMILY HOSPITAL",
  "pages": [61, 62],
  "text": "בן 58 ... צילום - שבר בסיס מסרק 5 ... חופש מחלה חודש ...",
  "source": "/home/chezy/rag_medical/med_patient#1.pdf",
  "patient_name": "חביבאללה סאמי",
  "found_dates": ["2025-01-21"],
  "detected_keywords": ["אישור/חופש מחלה", "מצב תפקודי"]
}
```

### ocr_embeddings/meta.jsonl (אחרי צ'אנקינג)
כל שורה מייצגת צ'אנק בודד ומכילה:
- `row_id` (int): מזהה שורה תואם לאינדקס FAISS.
- `document_id`, `document_type`, `document_date`, `issuer`, `pages`, `source`, `patient_name`, `found_dates`, `detected_keywords`: נלקח מן המסמך האב.
- `chunk_index` (int): אינדקס הצ'אנק בתוך המסמך.
- `text` (string): טקסט הצ'אנק (כ־900 תווים, חפיפה ~120 תווים).

דוגמה קצרה:
```json
{
  "row_id": 52,
  "document_id": "OCC-2025-06-23",
  "document_type": "טופס סיכום בדיקה רפואית (רפואה תעסוקתית)",
  "document_date": "2025-06-23",
  "issuer": "כללית",
  "pages": [12],
  "source": "/home/chezy/rag_medical/med_patient#1.pdf",
  "patient_name": "חביבאללה סאמי",
  "found_dates": ["2025-06-23", "2025-09-20"],
  "detected_keywords": ["רפואה תעסוקתית", "אישור/חופש מחלה"],
  "chunk_index": 0,
  "text": "אינו יכול לחזור עדיין לעבודתו ויש לאשר המשך חופש מחלה ... עד תאריך 20/09/2025 ..."
}
```

### model.json
```json
{
  "model": "intfloat/multilingual-e5-large",
  "dim": 1024,
  "device": "cuda|cpu"
}
```

### הנחיות שימוש ברטריבר
- סינון לפי טיפוס מסמך:
  - מצב תפקודי: `document_type in ["סיכום טיפול פיזיותרפיה", "דוח ביקור מרפאה", "ועדה רפואית"]`.
  - חזרה לעבודה: `document_type == "טופס סיכום בדיקה רפואית (רפואה תעסוקתית)"`.
  - אישור/חופש מחלה: `document_type in ["תעודה רפואית לנפגע בעבודה", "דוח שחרור", "דוח ביקור מרפאה"]`.
- עדיפות בזמן: מיינו תוצאות לפי `document_date desc` כאשר השאלה מבקשת מידע "עדכני".
- ציטוטים: לשיוך מספר עמוד, השתמשו בשדה `pages` של המסמך האב לציון העמוד(ים) המקוריים. (הרחבה עתידית: שיוך עמוד מוערך לכל צ'אנק).

### פרמטרי צ'אנקינג (ברירת מחדל)
- אורך יעד: ~900 תווים, חפיפה: ~120 תווים, מפרק משפטים בעברית (פיסוק/שבירת שורה).


